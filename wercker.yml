box: node

build:
  steps:
    - npm-install
    - npm-test
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"

docker-push:
  steps:
    - script:
        name: git sha version info
        code: |
          echo ${WERCKER_GIT_COMMIT:0:7} > VERSION.txt
          echo "version info..."
          cat VERSION.txt
    - internal/docker-push:
        username: _json_key
        password: $GCR_JSON_KEY_FILE
        repository: gcr.io/swarm-sandbox/jbaas
        tag: ${WERCKER_GIT_COMMIT:0:7}
        registry: https://gcr.io
    - internal/docker-push:
        username: $DOCKERCLOUD_USERNAME
        password: $DOCKERCLOUD_PASSWORD
        repository: naartjie/jbaas
        tag: ${WERCKER_GIT_COMMIT:0:7}
        registry: https://registry.hub.docker.com/v2

rolling-update:
  - kubectl:
      server: $K8S_MASTER
      username: _json_key
      password: $GCR_JSON_KEY_FILE
      insecure-skip-tls-verify: true
      command: rolling-update jbaas
      image: gcr.io/swarm-sandbox/jbaas:$WERCKER_GIT_COMMIT
